<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>COVID-19 Narrative Visualization</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    .scene { display: none; padding: 40px; }
    .active { display: block; }
    svg { width: 100%; height: 500px; }
    button { margin-top: 20px; padding: 10px 20px; }
    #dropdown { margin-top: 20px; }
  </style>
</head>
<body>
  <div id="scene1" class="scene active">
    <h2>Scene 1: Where It Started</h2>
    <p>First confirmed U.S. COVID-19 case reported in Washington on Jan 21, 2020.</p>
    <svg id="mapScene"></svg>
    <button onclick="nextScene(2)">See What Happened Next</button>
  </div>

  <div id="scene2" class="scene">
    <h2>Scene 2: Surges and Spikes</h2>
    <svg id="usTrend"></svg>
    <button onclick="nextScene(3)">What About Individual States?</button>
  </div>

  <div id="scene3" class="scene">
    <h2>Scene 3: State-by-State Peaks</h2>
    <svg id="barChart"></svg>
    <button onclick="nextScene(4)">Explore Your State</button>
  </div>

  <div id="scene4" class="scene">
    <h2>Scene 4: Explore Your State</h2>
    <label for="dropdown">Select a state:</label>
    <select id="dropdown"></select>
    <svg id="stateLineChart"></svg>
  </div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    const scenes = [1, 2, 3, 4];
    function nextScene(n) {
      scenes.forEach(i => document.getElementById(`scene${i}`).classList.remove('active'));
      document.getElementById(`scene${n}`).classList.add('active');
    }

    let covidData = [], stateNames = [];

    d3.csv("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv", d3.autoType).then(data => {
      covidData = data;

      // SCENE 2: U.S. Total Daily Cases Line Chart
      const nested = d3.rollups(
        data,
        v => d3.sum(v, d => d.cases),
        d => d.date
      ).sort((a, b) => d3.ascending(a[0], b[0]));

      const dates = nested.map(d => d[0]);
      const totals = nested.map(d => d[1]);

      const width = 800, height = 500, margin = {top: 20, right: 30, bottom: 30, left: 50};
      const svg = d3.select("#usTrend")
        .attr("viewBox", [0, 0, width, height]);

      const x = d3.scaleTime()
        .domain(d3.extent(dates, d => new Date(d)))
        .range([margin.left, width - margin.right]);

      const y = d3.scaleLinear()
        .domain([0, d3.max(totals)]).nice()
        .range([height - margin.bottom, margin.top]);

      const line = d3.line()
        .x(d => x(new Date(d[0])))
        .y(d => y(d[1]));

      svg.append("g")
        .attr("transform", `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(x));

      svg.append("g")
        .attr("transform", `translate(${margin.left},0)`)
        .call(d3.axisLeft(y));

      svg.append("path")
        .datum(nested)
        .attr("fill", "none")
        .attr("stroke", "steelblue")
        .attr("stroke-width", 2)
        .attr("d", line);

      // SCENE 3: Bar chart of peak daily cases per state
      const peakByState = d3.rollups(
        data,
        v => d3.max(v, d => d.cases - (v[v.indexOf(d) - 1]?.cases || 0)),
        d => d.state
      ).sort((a, b) => d3.descending(a[1], b[1]));

      const svgBar = d3.select("#barChart")
        .attr("viewBox", [0, 0, width, height]);

      const xBar = d3.scaleLinear()
        .domain([0, d3.max(peakByState, d => d[1])]).nice()
        .range([margin.left, width - margin.right]);

      const yBar = d3.scaleBand()
        .domain(peakByState.map(d => d[0]))
        .range([margin.top, height - margin.bottom])
        .padding(0.1);

      svgBar.append("g")
        .attr("transform", `translate(0,${margin.top})`)
        .call(d3.axisTop(xBar));

      svgBar.append("g")
        .attr("transform", `translate(${margin.left},0)`)
        .call(d3.axisLeft(yBar));

      svgBar.selectAll("rect")
        .data(peakByState)
        .enter().append("rect")
        .attr("x", xBar(0))
        .attr("y", d => yBar(d[0]))
        .attr("width", d => xBar(d[1]) - xBar(0))
        .attr("height", yBar.bandwidth())
        .attr("fill", "darkorange");

      // SCENE 4: Populate dropdown and plot per-state chart
      stateNames = Array.from(new Set(data.map(d => d.state))).sort();
      const dropdown = d3.select("#dropdown");
      dropdown.selectAll("option")
        .data(stateNames)
        .enter()
        .append("option")
        .text(d => d);

      dropdown.on("change", function(e) {
        updateStateChart(e.target.value);
      });

      // Initial state chart
      updateStateChart("California");
    });

    function updateStateChart(state) {
      const filtered = covidData.filter(d => d.state === state);
      const nested = filtered.map(d => [new Date(d.date), d.cases]);

      const svg = d3.select("#stateLineChart");
      svg.selectAll("*").remove();

      const width = 800, height = 500, margin = {top: 20, right: 30, bottom: 30, left: 50};

      const x = d3.scaleTime()
        .domain(d3.extent(nested, d => d[0]))
        .range([margin.left, width - margin.right]);

      const y = d3.scaleLinear()
        .domain([0, d3.max(nested, d => d[1])]).nice()
        .range([height - margin.bottom, margin.top]);

      const line = d3.line()
        .x(d => x(d[0]))
        .y(d => y(d[1]));

      svg.attr("viewBox", [0, 0, width, height]);

      svg.append("g")
        .attr("transform", `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(x));

      svg.append("g")
        .attr("transform", `translate(${margin.left},0)`)
        .call(d3.axisLeft(y));

      svg.append("path")
        .datum(nested)
        .attr("fill", "none")
        .attr("stroke", "crimson")
        .attr("stroke-width", 2)
        .attr("d", line);
    }
  </script>
</body>
</html>
